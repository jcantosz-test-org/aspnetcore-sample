name: Get Next Version (Windows)

on:
  workflow_call:
    inputs:
      TAG_PREFIX:
        required: false
        type: string
        default: "v"
      FALLBACK_TAG:
        required: false
        type: string
        default: "1"
      TAG_FORMAT:
        required: false
        type: string
        default: '[0-9]+$'
    secrets:
      GH_TOKEN:
        required: true
    outputs:
      NEXT_VERSION:
        description: "The next version to release"
        value: ${{ jobs.create-version.outputs.NEXT_VERSION }}

jobs:
  create-version:
    runs-on: windows-2019
    environment: ${{ inputs.ENVIRONMENT }}
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    outputs:
      NEXT_VERSION: ${{ steps.get-next-version.outputs.NEXT_VERSION }}
    steps:
      - uses: actions/checkout@v3
      - name: get next version
        id: get-next-version
        run: |
          git fetch --tags
          $TAGS=(git tag)
          $CURR_TAG="${{ inputs.FALLBACK_TAG }}"

          if (![string]::IsNullOrEmpty($TAGS)) {
            # Cast and sort the version as an integer and grab the largest one, set to 0 if cant find anything
            $CURR_TAGS=($TAGS | select-string "${{ inputs.TAG_PREFIX }}${{ inputs.TAG_FORMAT }}"| ForEach-Object -Process { [int64]$_.toString().trimStart("v")} | sort-object -Descending)
         
            # If tags list is not empty, take the first tag as the current tag and increment it
            if ( $CURR_TAGS.count -gt 0 ) {
              $CURR_TAG=($CURR_TAGS[0] + 1)
            } # else use the fallback tag
          }

          $NEXT_VERSION=("${{ inputs.TAG_PREFIX }}{0:#}" -f $CURR_TAG)

          # Set as output
          echo $NEXT_VERSION
          echo "NEXT_VERSION=$NEXT_VERSION" >> $env:GITHUB_OUTPUT


          # For Semvers
          # $CURR_TAG=(git tag | select-string "v[0-9]+" | ForEach-Object -Process { [Version]$_.toString().trimStart("v")} | sort-object -Descending)[0] || [Version]"0.0.0"
          # $CURR_TAG=[Version]::new($CURR_TAG.Major, $CURR_TAG.Minor, $CURR_TAG.Build + 1)


